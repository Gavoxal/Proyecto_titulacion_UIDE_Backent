generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 1. Usuarios
model Usuario {
  id                  Int      @id @default(autoincrement())
  cedula              String   @unique @db.VarChar(15)
  nombres             String   @db.VarChar(191)
  apellidos           String   @db.VarChar(191)
  correoInstitucional String   @unique @map("correo_institucional") @db.VarChar(191)
  rol                 Rol      @default(ESTUDIANTE)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  propuestas          Propuesta[] @relation("EstudiantePropuesta")
  propuestasTutoradas Propuesta[] @relation("TutorPropuesta")

  // Revisando SQL: 
  // Actividades tienen FK usuarios_id -> El docente que crea la actividad? O el estudiante asignado?
  // En SQL: Actividades.usuarios_id -> usuarios.id.
  // Evidencia -> Actividades_id.
  // Comentarios -> usuarios_id (Quien comenta).

  actividadesCreadas Actividad[]    @relation("UsuarioActividad")
  comentarios        Comentario[]
  notificaciones     Notificacion[]
  comiteAsignaciones Comite[]
  prerequisitos      Prerequisito[]

  estudiantePerfil Estudiante?
  auth             Auth?

  @@map("usuarios")
}

model Auth {
  id        Int     @id @default(autoincrement())
  username  String  @unique @db.VarChar(191)
  password  String  @db.VarChar(191)
  usuarioId Int     @unique @map("usuario_id")
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  @@map("auth")
}

enum Rol {
  ESTUDIANTE
  TUTOR
  DIRECTOR
  COORDINADOR
  COMITE
  DOCENTE_INTEGRACION
  //Revisor
}

// 2. Propuestas
model Propuesta {
  id               Int               @id @default(autoincrement())
  titulo           String            @db.VarChar(191)
  objetivos        String            @db.Text
  problematica     String?           @db.Text
  areaConocimiento AreaConocimiento  @map("area_conocimiento")
  alcance          String?           @db.VarChar(191)
  archivoUrl       String?           @map("archivo_url") @db.VarChar(191)
  fechaPublicacion DateTime          @default(now()) @map("fecha_publicacion")
  estado           EstadoPropuesta   @default(PENDIENTE)
  fkEstudiante     Int               @map("fk_estudiante")
  tutorId          Int?              @map("tutor_id")
  fechaDefensa     DateTime?         @map("fecha_defensa")
  resultadoDefensa ResultadoDefensa? @default(PENDIENTE) @map("resultado_defensa")

  estudiante         Usuario           @relation("EstudiantePropuesta", fields: [fkEstudiante], references: [id])
  tutor              Usuario?          @relation("TutorPropuesta", fields: [tutorId], references: [id])
  actividades        Actividad[]
  comiteAsignaciones Comite[]
  entregablesFinales EntregableFinal[]

  @@map("propuestas")
}

enum AreaConocimiento {
  CIENCIA_DE_DATOS_E_INTELIGENCIA_ARTIFICIAL
  GESTION_DE_LA_INFORMACION_Y_TRANSFORMACION_DIGITAL
  INFRAESTRUCTURA_TI_Y_CIBERSEGURIDAD
  INNOVACION_EMPRENDIMIENTO_Y_ETICA_TECNOLOGICA
  PROGRAMACION_Y_DESARROLLO_DE_SOFTWARE
}

enum EstadoPropuesta {
  PENDIENTE
  APROBADA
  APROBADA_CON_COMENTARIOS
  RECHAZADA
}

// 3. Actividades
model Actividad {
  idActividades Int     @id @default(autoincrement())
  nombre        String? @db.VarChar(45)
  descripcion   String? @db.VarChar(45)
  propuestasId  Int     @map("propuestas_id")
  usuariosId    Int     @map("usuarios_id")

  propuesta  Propuesta   @relation(fields: [propuestasId], references: [id])
  usuario    Usuario     @relation("UsuarioActividad", fields: [usuariosId], references: [id])
  evidencias Evidencia[]

  @@map("Actividades")
}

// 4. Evidencia (Avances)
model Evidencia {
  id            Int             @id @default(autoincrement())
  semana        Int
  contenido     String          @db.Text
  archivoUrl    String?         @map("archivo_url") @db.VarChar(191)
  fechaEntrega  DateTime        @default(now()) @map("fecha_entrega")
  estado        EstadoEvidencia @default(ENTREGADO)
  calificacion  Decimal?        @db.Decimal(4, 2)
  actividadesId Int             @map("Actividades_idActividades")

  actividad   Actividad    @relation(fields: [actividadesId], references: [idActividades])
  comentarios Comentario[]

  @@map("Evidencia")
}

enum EstadoEvidencia {
  ENTREGADO
  NO_ENTREGADO
}

model Comentario {
  idComentarios Int     @id @default(autoincrement())
  descripcion   String? @db.VarChar(45)
  evidenciaId   Int     @map("Evidencia_id")
  usuariosId    Int     @map("usuarios_id")

  evidencia Evidencia @relation(fields: [evidenciaId], references: [id])
  usuario   Usuario   @relation(fields: [usuariosId], references: [id])

  @@map("Comentarios")
}

// 6. Prerequisitos (Estaba en SQL original, parece que falta en reporte v2 pero estaba en v1)
model Prerequisito {
  id           Int     @id @default(autoincrement())
  nombre       String  @db.VarChar(191)
  descripcion  String? @db.VarChar(191)
  cumplido     Boolean @default(false)
  archivoUrl   String? @map("archivo_url") @db.VarChar(191)
  fkEstudiante Int     @map("fk_estudiante")

  estudiante Usuario @relation(fields: [fkEstudiante], references: [id])

  @@map("prerequisitos")
}

// 7. Notificaciones (Nuevo)
model Notificacion {
  id            Int      @id @default(autoincrement())
  mensaje       String   @db.Text
  leido         Boolean  @default(false)
  fechaCreacion DateTime @default(now()) @map("fecha_creacion")
  usuariosId    Int      @map("usuarios_id")

  usuario Usuario @relation(fields: [usuariosId], references: [id])

  @@map("notificaciones")
}

// 8. Entregables Finales (Nuevo)
model EntregableFinal {
  id           Int            @id @default(autoincrement())
  tipo         TipoEntregable
  urlArchivo   String         @map("url_archivo") @db.VarChar(255)
  fechaSubida  DateTime       @default(now()) @map("fecha_subida")
  propuestasId Int            @map("propuestas_id")

  propuesta Propuesta @relation(fields: [propuestasId], references: [id])

  @@map("entregables_finales")
}

enum TipoEntregable {
  TESIS
  MANUAL_USUARIO
  REPOSITORIO
  ARTICULO
}

// 9. Comite (Corregido)
model Comite {
  usuariosId    Int       @map("usuarios_id")
  propuestasId  Int       @map("propuestas_id")
  rol           RolComite
  calificacion  Decimal?  @db.Decimal(4, 2)
  fechaAsignada DateTime? @map("fecha_asignada") @db.Date

  usuario   Usuario   @relation(fields: [usuariosId], references: [id])
  propuesta Propuesta @relation(fields: [propuestasId], references: [id])

  @@id([usuariosId, propuestasId])
  @@map("comite")
}

enum RolComite {
  JURADO_1   @map("Jurado 1")
  JURADO_2   @map("Jurado 2")
  PRESIDENTE @map("Presidente")
}

enum ResultadoDefensa {
  APROBADO
  REPROBADO
  PENDIENTE
}

// 10. Estudiante Perfil (Nuevo)
model Estudiante {
  id             Int     @id @default(autoincrement())
  sexo           String? @db.VarChar(20)
  estadoEscuela  String? @map("estado_escuela") @db.VarChar(50)
  sede           String? @db.VarChar(100)
  escuela        String? @db.VarChar(100)
  codigoMalla    String? @map("codigo_malla") @db.VarChar(50)
  malla          String? @db.VarChar(100)
  periodoLectivo String? @map("periodo_lectivo") @db.VarChar(100)
  ciudad         String? @db.VarChar(100)
  provincia      String? @db.VarChar(100)
  pais           String? @db.VarChar(100)

  usuarioId Int     @unique @map("usuario_id")
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  @@map("estudiantes_perfil")
}
