generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                            Int                          @id @default(autoincrement())
  cedula                        String                       @unique @db.VarChar(15)
  nombres                       String
  apellidos                     String
  correoInstitucional           String                       @unique @map("correo_institucional")
  rol                           Rol                          @default(ESTUDIANTE)
  designacion                   String?                      @db.VarChar(100)
  createdAt                     DateTime                     @default(now()) @map("created_at")
  updatedAt                     DateTime                     @updatedAt @map("updated_at")
  auth                          Auth?
  reunionesComoEstudiante       BitacoraReunion[]            @relation("EstudianteReuniones")
  reunionesComoTutor            BitacoraReunion[]            @relation("TutorReuniones")
  comentarios                   Comentario[]
  comites                       Comite[]
  prerequisitos                 EstudiantePrerequisito[]
  estudiantePerfil              EstudiantePerfil?
  notificaciones                Notificacion[]
  participacionesDefensaPrivada ParticipanteDefensaPrivada[] @relation("ParticipantesDefensaPrivada")
  participacionesDefensaPublica ParticipanteDefensaPublica[] @relation("ParticipantesDefensaPublica")
  propuestas                    Propuesta[]
  propuestasRevisadas           Propuesta[]                  @relation("PropuestasRevisadas")
  trabajosTitulacion            TrabajoTitulacion[]          @relation("TutorTrabajos")
  tutorPerfil                   TutorPerfil?
  votacionesComoEstudiante      VotacionTutor[]              @relation("EstudianteVotaciones")
  votacionesComoTutor           VotacionTutor[]              @relation("TutorVotaciones")

  @@map("usuarios")
}

model Auth {
  id        Int     @id @default(autoincrement())
  username  String  @unique
  password  String
  usuarioId Int     @unique @map("usuario_id")
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  @@map("auth")
}

model AreaConocimiento {
  id          Int         @id @default(autoincrement())
  codigo      String      @unique @db.VarChar(50)
  nombre      String
  descripcion String?     @db.Text
  propuestas  Propuesta[]

  @@map("areas_conocimiento")
}

model Propuesta {
  id                 Int                       @id @default(autoincrement())
  titulo             String
  objetivos          String                    @db.Text
  problematica       String?                   @db.Text
  areaConocimientoId Int                       @map("area_conocimiento_id")
  alcance            String?
  archivoUrl         String?                   @map("archivo_url")
  fechaPublicacion   DateTime                  @default(now()) @map("fecha_publicacion")
  estado             EstadoPropuesta           @default(PENDIENTE)
  fkEstudiante       Int                       @map("fk_estudiante")
  fechaDefensa       DateTime?                 @map("fecha_defensa")
  resultadoDefensa   ResultadoDefensa?         @default(PENDIENTE) @map("resultado_defensa")
  carrera            String?
  malla              String?                   @db.VarChar(100)
  comentarioRevision String?                   @map("comentario_revision") @db.Text
  fechaRevision      DateTime?                 @map("fecha_revision")
  revisadoPor        Int?                      @map("revisado_por")
  actividades        Actividad[]
  bitacoraReuniones  BitacoraReunion[]
  comentarios        Comentario[]
  comites            Comite[]
  entregablesFinales EntregableFinal[]
  defensaPrivada     EvaluacionDefensaPrivada?
  defensaPublica     EvaluacionDefensaPublica?
  areaConocimiento   AreaConocimiento          @relation(fields: [areaConocimientoId], references: [id])
  estudiante         Usuario                   @relation(fields: [fkEstudiante], references: [id])
  revisor            Usuario?                  @relation("PropuestasRevisadas", fields: [revisadoPor], references: [id])
  trabajosTitulacion TrabajoTitulacion[]
  votacionesTutor    VotacionTutor[]

  @@index([areaConocimientoId], map: "propuestas_area_conocimiento_id_fkey")
  @@index([fkEstudiante], map: "propuestas_fk_estudiante_fkey")
  @@index([revisadoPor], map: "propuestas_revisado_por_fkey")
  @@map("propuestas")
}

model TrabajoTitulacion {
  propuestasId     Int                   @map("propuestas_id")
  fkTutorId        Int                   @map("fk_tutor_id")
  fechaAsignacion  DateTime              @default(now()) @map("fecha_asignacion")
  estadoAsignacion EstadoAsignacionTutor @default(ACTIVO)
  observaciones    String?               @db.Text
  tutor            Usuario               @relation("TutorTrabajos", fields: [fkTutorId], references: [id])
  propuesta        Propuesta             @relation(fields: [propuestasId], references: [id])

  @@id([propuestasId, fkTutorId])
  @@index([fkTutorId], map: "trabajo_titulacion_fk_tutor_id_fkey")
  @@map("trabajo_titulacion")
}

model Actividad {
  id              Int             @id @default(autoincrement())
  nombre          String
  descripcion     String?         @db.Text
  propuestaId     Int             @map("propuesta_id")
  tipo            TipoActividad   @default(DOCENCIA)
  fechaAsignacion DateTime        @default(now()) @map("fecha_asignacion")
  fechaActivacion DateTime?       @map("fecha_activacion")
  fechaEntrega    DateTime?       @map("fecha_entrega")
  requisitos      Json?
  estado          EstadoActividad @default(NO_ENTREGADO)
  propuesta       Propuesta       @relation(fields: [propuestaId], references: [id])
  evidencias      Evidencia[]

  @@index([propuestaId], map: "actividades_propuesta_id_fkey")
  @@map("actividades")
}

model Evidencia {
  id                       Int             @id @default(autoincrement())
  semana                   Int
  contenido                String          @db.Text
  archivoUrl               String?         @map("archivo_url")
  fechaEntrega             DateTime        @default(now()) @map("fecha_entrega")
  estado                   EstadoEvidencia @default(ENTREGADO)
  actividadId              Int             @map("actividad_id")
  calificacionTutor        Decimal?        @map("calificacion_tutor") @db.Decimal(4, 2)
  feedbackTutor            String?         @map("feedback_tutor") @db.Text
  fechaCalificacionTutor   DateTime?       @map("fecha_calificacion_tutor")
  estadoRevisionTutor      EstadoRevision? @default(PENDIENTE) @map("estado_revision_tutor")
  calificacionDocente      Decimal?        @map("calificacion_docente") @db.Decimal(4, 2)
  feedbackDocente          String?         @map("feedback_docente") @db.Text
  fechaCalificacionDocente DateTime?       @map("fecha_calificacion_docente")
  estadoRevisionDocente    EstadoRevision? @default(PENDIENTE) @map("estado_revision_docente")
  calificacionFinal        Decimal?        @map("calificacion_final") @db.Decimal(4, 2)
  ponderacionTutor         Decimal         @default(0.40) @map("ponderacion_tutor") @db.Decimal(3, 2)
  ponderacionDocente       Decimal         @default(0.60) @map("ponderacion_docente") @db.Decimal(3, 2)
  comentarios              Comentario[]
  actividad                Actividad       @relation(fields: [actividadId], references: [id])

  @@index([actividadId], map: "evidencias_actividad_id_fkey")
  @@map("evidencias")
}

model Comentario {
  id          Int        @id @default(autoincrement())
  evidenciaId Int?       @map("evidencia_id")
  propuestaId Int?       @map("propuesta_id")
  usuarioId   Int        @map("usuario_id")
  descripcion String?    @db.Text
  evidencia   Evidencia? @relation(fields: [evidenciaId], references: [id], onDelete: Restrict)
  propuesta   Propuesta? @relation(fields: [propuestaId], references: [id], onDelete: Restrict)
  usuario     Usuario    @relation(fields: [usuarioId], references: [id])

  @@index([evidenciaId], map: "comentarios_evidencia_id_fkey")
  @@index([propuestaId], map: "comentarios_propuesta_id_fkey")
  @@index([usuarioId], map: "comentarios_usuario_id_fkey")
  @@map("comentarios")
}

model CatalogoPrerequisito {
  id                      Int                      @id @default(autoincrement())
  nombre                  String
  descripcion             String?                  @db.Text
  orden                   Int                      @default(1)
  activo                  Boolean                  @default(true)
  estudiantePrerequisitos EstudiantePrerequisito[]

  @@map("catalogo_prerequisitos")
}

model EstudiantePrerequisito {
  id                 Int                  @id @default(autoincrement())
  prerequisitoId     Int                  @map("prerequisito_id")
  cumplido           Boolean              @default(false)
  archivoUrl         String?              @map("archivo_url")
  fechaCumplimiento  DateTime?            @map("fecha_cumplimiento")
  fechaActualizacion DateTime?            @updatedAt @map("fecha_actualizacion")
  fkEstudiante       Int                  @map("fk_estudiante")
  estudiante         Usuario              @relation(fields: [fkEstudiante], references: [id])
  prerequisito       CatalogoPrerequisito @relation(fields: [prerequisitoId], references: [id])

  @@unique([fkEstudiante, prerequisitoId])
  @@index([prerequisitoId], map: "estudiante_prerequisitos_prerequisito_id_fkey")
  @@map("estudiante_prerequisitos")
}

model Notificacion {
  id            Int      @id @default(autoincrement())
  mensaje       String   @db.Text
  leido         Boolean  @default(false)
  fechaCreacion DateTime @default(now()) @map("fecha_creacion")
  usuarioId     Int      @map("usuario_id")
  usuario       Usuario  @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId], map: "notificaciones_usuario_id_fkey")
  @@map("notificaciones")
}

model EntregableFinal {
  id           Int            @id @default(autoincrement())
  tipo         TipoEntregable
  urlArchivo   String         @map("url_archivo") @db.VarChar(255)
  fechaSubida  DateTime       @default(now()) @map("fecha_subida")
  propuestasId Int            @map("propuestas_id")
  version      Int            @default(1)
  isActive     Boolean        @default(true) @map("is_active")
  propuesta    Propuesta      @relation(fields: [propuestasId], references: [id])

  @@index([propuestasId], map: "entregables_finales_propuestas_id_fkey")
  @@map("entregables_finales")
}

model Comite {
  usuarioId     Int          @map("usuario_id")
  propuestaId   Int          @map("trabajo_titulacion_propuestas_id")
  rol           RolComite
  calificacion  Decimal?     @db.Decimal(4, 2)
  fechaAsignada DateTime?    @map("fecha_asignada") @db.Date
  horaDefensa   DateTime?    @map("hora_defensa") @db.Time(0)
  aulaDefensa   String?      @map("aula_defensa") @db.VarChar(50)
  comentarios   String?      @db.Text
  estado        EstadoComite @default(ACTIVO)
  propuesta     Propuesta    @relation(fields: [propuestaId], references: [id])
  usuario       Usuario      @relation(fields: [usuarioId], references: [id])

  @@id([usuarioId, propuestaId])
  @@index([propuestaId], map: "comite_trabajo_titulacion_propuestas_id_fkey")
  @@map("comite")
}

model EstudiantePerfil {
  id             Int     @id @default(autoincrement())
  sexo           String? @db.VarChar(20)
  estadoEscuela  String? @map("estado_escuela") @db.VarChar(50)
  sede           String? @db.VarChar(100)
  escuela        String? @db.VarChar(100)
  codigoMalla    String? @map("codigo_malla") @db.VarChar(50)
  malla          String? @db.VarChar(100)
  periodoLectivo String? @map("periodo_lectivo") @db.VarChar(100)
  ciudad         String? @db.VarChar(100)
  provincia      String? @db.VarChar(100)
  pais           String? @db.VarChar(100)
  usuarioId      Int     @unique @map("usuario_id")
  usuario        Usuario @relation(fields: [usuarioId], references: [id])

  @@map("estudiantes_perfil")
}

model TutorPerfil {
  id           Int     @id @default(autoincrement())
  titulo       String? @db.VarChar(100)
  celular      String? @db.VarChar(20)
  sede         String? @db.VarChar(100)
  departamento String? @db.VarChar(100)
  especialidad String? @db.VarChar(100)
  usuarioId    Int     @unique @map("usuario_id")
  usuario      Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("tutor_perfil")
}

model McpAuth {
  id        Int      @id @default(autoincrement())
  email     String
  codigo    String   @db.VarChar(6)
  token     String?  @db.VarChar(64)
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")

  @@index([email])
  @@index([token])
  @@map("mcp_auth")
}

model BitacoraReunion {
  id           Int              @id @default(autoincrement())
  tutorId      Int              @map("tutor_id")
  estudianteId Int              @map("estudiante_id")
  propuestaId  Int              @map("propuesta_id")
  fecha        DateTime         @db.Date
  horaInicio   DateTime         @map("hora_inicio") @db.Time(0)
  horaFin      DateTime         @map("hora_fin") @db.Time(0)
  modalidad    ModalidadReunion
  motivo       String
  resumen      String?          @db.Text
  compromisos  Json?
  asistio      Boolean          @default(false)
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  estudiante   Usuario          @relation("EstudianteReuniones", fields: [estudianteId], references: [id])
  propuesta    Propuesta        @relation(fields: [propuestaId], references: [id])
  tutor        Usuario          @relation("TutorReuniones", fields: [tutorId], references: [id])

  @@index([tutorId, estudianteId])
  @@index([propuestaId])
  @@index([estudianteId], map: "bitacora_reuniones_estudiante_id_fkey")
  @@map("bitacora_reuniones")
}

model VotacionTutor {
  id            Int       @id @default(autoincrement())
  estudianteId  Int       @map("estudiante_id")
  tutorId       Int       @map("tutor_id")
  propuestaId   Int       @map("propuesta_id")
  prioridad     Int
  justificacion String?   @db.Text
  fechaVotacion DateTime  @default(now()) @map("fecha_votacion")
  estudiante    Usuario   @relation("EstudianteVotaciones", fields: [estudianteId], references: [id])
  propuesta     Propuesta @relation(fields: [propuestaId], references: [id])
  tutor         Usuario   @relation("TutorVotaciones", fields: [tutorId], references: [id])

  @@unique([estudianteId, propuestaId, prioridad])
  @@index([propuestaId])
  @@index([tutorId], map: "votacion_tutores_tutor_id_fkey")
  @@map("votacion_tutores")
}

model EvaluacionDefensaPrivada {
  id              Int                          @id @default(autoincrement())
  propuestaId     Int                          @unique @map("propuesta_id")
  fechaDefensa    DateTime?                    @map("fecha_defensa") @db.Date
  horaDefensa     DateTime?                    @map("hora_defensa") @db.Time(0)
  aula            String?                      @db.VarChar(50)
  estado          EstadoDefensaPrivada         @default(PENDIENTE)
  calificacion    Decimal?                     @db.Decimal(4, 2)
  comentarios     String?                      @db.Text
  fechaEvaluacion DateTime?                    @map("fecha_evaluacion")
  propuesta       Propuesta                    @relation(fields: [propuestaId], references: [id])
  participantes   ParticipanteDefensaPrivada[]

  @@map("evaluacion_defensa_privada")
}

model ParticipanteDefensaPrivada {
  evaluacionId     Int                      @map("evaluacion_id")
  usuarioId        Int                      @map("usuario_id")
  tipoParticipante TipoParticipanteDefensa  @map("tipo_participante")
  rol              String?                  @db.VarChar(50)
  comentario       String?                  @db.Text
  calificacion     Decimal?                 @db.Decimal(4, 2)
  evaluacion       EvaluacionDefensaPrivada @relation(fields: [evaluacionId], references: [id], onDelete: Cascade)
  usuario          Usuario                  @relation("ParticipantesDefensaPrivada", fields: [usuarioId], references: [id])

  @@id([evaluacionId, usuarioId])
  @@index([usuarioId], map: "participante_defensa_privada_usuario_id_fkey")
  @@map("participante_defensa_privada")
}

model EvaluacionDefensaPublica {
  id              Int                          @id @default(autoincrement())
  propuestaId     Int                          @unique @map("propuesta_id")
  fechaDefensa    DateTime?                    @map("fecha_defensa") @db.Date
  horaDefensa     DateTime?                    @map("hora_defensa") @db.Time(0)
  aula            String?                      @db.VarChar(50)
  estado          EstadoDefensaPublica         @default(BLOQUEADA)
  calificacion    Decimal?                     @db.Decimal(4, 2)
  comentarios     String?                      @db.Text
  fechaEvaluacion DateTime?                    @map("fecha_evaluacion")
  propuesta       Propuesta                    @relation(fields: [propuestaId], references: [id])
  participantes   ParticipanteDefensaPublica[]

  @@map("evaluacion_defensa_publica")
}

model ParticipanteDefensaPublica {
  evaluacionId     Int                      @map("evaluacion_id")
  usuarioId        Int                      @map("usuario_id")
  tipoParticipante TipoParticipanteDefensa  @map("tipo_participante")
  rol              String?                  @db.VarChar(50)
  comentario       String?                  @db.Text
  calificacion     Decimal?                 @db.Decimal(4, 2)
  evaluacion       EvaluacionDefensaPublica @relation(fields: [evaluacionId], references: [id], onDelete: Cascade)
  usuario          Usuario                  @relation("ParticipantesDefensaPublica", fields: [usuarioId], references: [id])

  @@id([evaluacionId, usuarioId])
  @@index([usuarioId], map: "participante_defensa_publica_usuario_id_fkey")
  @@map("participante_defensa_publica")
}

enum Rol {
  ESTUDIANTE
  TUTOR
  DIRECTOR
  COORDINADOR
  COMITE
  DOCENTE_INTEGRACION
}

enum EstadoPropuesta {
  PENDIENTE
  APROBADA
  APROBADA_CON_COMENTARIOS
  RECHAZADA
}

enum ResultadoDefensa {
  APROBADO
  REPROBADO
  PENDIENTE
}

enum TipoActividad {
  DOCENCIA
  TUTORIA
}

enum EstadoActividad {
  ENTREGADO
  NO_ENTREGADO
}

enum EstadoEvidencia {
  ENTREGADO
  NO_ENTREGADO
}

enum EstadoRevision {
  PENDIENTE
  APROBADO
  RECHAZADO
  REQUIERE_CAMBIOS
}

enum TipoEntregable {
  TESIS
  MANUAL_USUARIO
  REPOSITORIO
  ARTICULO
}

enum RolComite {
  JURADO_1   @map("Jurado 1")
  JURADO_2   @map("Jurado 2")
  PRESIDENTE @map("Presidente")
}

enum EstadoComite {
  ACTIVO
  INACTIVO
}

enum EstadoAsignacionTutor {
  ACTIVO
  REASIGNADO
  FINALIZADO
}

enum ModalidadReunion {
  PRESENCIAL
  VIRTUAL
  HIBRIDA
}

enum TipoParticipanteDefensa {
  TUTOR
  COMITE
  DIRECTOR
  COORDINADOR
}

enum EstadoDefensaPrivada {
  PENDIENTE
  PROGRAMADA
  APROBADA
  RECHAZADA
}

enum EstadoDefensaPublica {
  BLOQUEADA
  PENDIENTE
  PROGRAMADA
  APROBADA
  RECHAZADA
}
